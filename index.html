<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule a Callback</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Optional: Extend Tailwind theme for Inter font if not default
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Inter Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Default light gray background */
            margin: 0; /* Ensure no default margin from browser */
            padding: 1rem; /* Add some padding for when embedded */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh; /* Ensure it takes at least full viewport height */
            box-sizing: border-box;
        }
        .input-icon-group {
            position: relative;
        }
        .input-icon-group .icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af; /* gray-400 */
        }
        .input-icon-group input[type="date"],
        .input-icon-group input[type="time"] {
            padding-left: 2.5rem;
        }
        .message-area {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            width: 100%;
            max-width: 480px; /* Consistent with form width */
            box-sizing: border-box;
        }
        .message-area.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            height: 0;
            margin-bottom: 0;
            overflow: hidden;
        }
         .message-area.visible {
            opacity: 1;
            transform: translateY(0);
            height: auto; /* Adjust as needed or set specific height */
            margin-bottom: 1rem; /* Space below message */
        }
        /* Ensure form elements are not too wide on larger screens if embedded in a wide iframe */
        .form-container {
            width: 100%;
            max-width: 480px; /* Max width for the form itself */
        }
    </style>
</head>
<body>

    <div class="form-container">
        <!-- Message Area for notifications -->
        <div id="messageArea" class="message-area hidden mb-4 p-3 rounded-lg text-white text-sm">
            <!-- Messages will be injected here by JavaScript -->
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 text-center">Schedule a Callback</h1>

            <!-- Scheduling Form -->
            <form id="scheduleFormElement"> <!-- Changed to form element for better semantics -->
                <div class="space-y-5">
                    <!-- Date and Time Inputs -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date and Time</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="input-icon-group">
                                <svg class="icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <input type="date" id="date" name="date" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                            </div>
                            <div class="input-icon-group">
                                <svg class="icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <input type="time" id="time" name="time" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                            </div>
                        </div>
                    </div>

                    <!-- Callback Phone Number Choice -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Callback Phone Number</label>
                        <div class="space-y-2 sm:space-y-0 sm:flex sm:space-x-4">
                            <div class="flex items-center">
                                <input id="thisNumber" name="callbackNumberType" type="radio" value="this" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 rounded">
                                <label for="thisNumber" class="ml-2 block text-sm text-gray-800">This Phone Number</label>
                            </div>
                            <div class="flex items-center">
                                <input id="alternateNumber" name="callbackNumberType" type="radio" value="alternate" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 rounded">
                                <label for="alternateNumber" class="ml-2 block text-sm text-gray-800">Alternate Phone Number</label>
                            </div>
                        </div>
                    </div>

                    <!-- Alternate Phone Number Input (Initially Hidden) -->
                    <div id="alternateNumberInputDiv" class="hidden space-y-1">
                        <label for="alternatePhoneNumber" class="block text-sm font-medium text-gray-700">Alternate Phone Number</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <select id="countryCode" name="countryCode" class="sm:w-1/3 px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                                <option value="+44" selected>UK (+44)</option>
                                <option value="+1">USA (+1)</option>
                                <option value="+33">France (+33)</option>
                                <option value="+49">Germany (+49)</option>
                                <option value="+81">Japan (+81)</option>
                                <!-- Add more country codes as needed -->
                            </select>
                            <input type="tel" id="alternatePhoneNumber" name="alternatePhoneNumber" placeholder="Enter phone number" class="flex-grow px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                        </div>
                    </div>

                    <!-- Schedule Button -->
                    <div>
                        <button type="submit" id="scheduleButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Schedule Callback
                        </button>
                    </div>
                </div>
            </form>

            <!-- Scheduled Message Display (Initially Hidden) -->
            <div id="scheduledMessageDisplay" class="hidden mt-6 text-center">
                <div class="bg-green-50 border border-green-300 p-4 rounded-lg">
                    <p class="text-green-700 text-sm">Callback successfully scheduled for: <strong id="scheduledDateTimeText" class="font-semibold"></strong></p>
                    <p class="text-green-700 text-sm mt-1">Phone: <strong id="scheduledPhoneNumberText" class="font-semibold"></strong></p>
                </div>
                <button id="rescheduleButton" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                    Reschedule
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- IMPORTANT: CONFIGURE YOUR CLOUD FUNCTION URL ---
            const CLOUD_FUNCTION_URL = 'https://us-central1-ujet-demo-credit-9gde.cloudfunctions.net/gcpteam-scheduled-callback-function'; // e.g., https://us-central1-your-project.cloudfunctions.net/scheduleCallback

            // DOM Elements
            const scheduleFormDiv = document.getElementById('scheduleFormElement').parentElement.parentElement; // The div containing the form
            const scheduleFormElement = document.getElementById('scheduleFormElement');
            const scheduledMessageDisplay = document.getElementById('scheduledMessageDisplay');
            const dateInput = document.getElementById('date');
            const timeInput = document.getElementById('time');
            const callbackNumberTypeRadios = document.querySelectorAll('input[name="callbackNumberType"]');
            const alternateNumberInputDiv = document.getElementById('alternateNumberInputDiv');
            const countryCodeSelect = document.getElementById('countryCode');
            const alternatePhoneNumberInput = document.getElementById('alternatePhoneNumber');
            const scheduleButton = document.getElementById('scheduleButton');
            const rescheduleButton = document.getElementById('rescheduleButton');
            const scheduledDateTimeText = document.getElementById('scheduledDateTimeText');
            const scheduledPhoneNumberText = document.getElementById('scheduledPhoneNumberText');
            const messageArea = document.getElementById('messageArea');

            function showMessage(message, type = 'error') {
                messageArea.textContent = message;
                messageArea.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-blue-500', 'opacity-0', 'translate-y-[-10px]', 'pointer-events-none');
                messageArea.classList.add('visible');

                if (type === 'error') {
                    messageArea.classList.add('bg-red-500');
                } else if (type === 'success') {
                    messageArea.classList.add('bg-green-500');
                } else {
                    messageArea.classList.add('bg-blue-500');
                }
                
                // Auto-hide message
                setTimeout(() => {
                    messageArea.classList.remove('visible');
                    messageArea.classList.add('opacity-0', 'translate-y-[-10px]', 'pointer-events-none');
                     setTimeout(() => messageArea.classList.add('hidden'), 300); // Fully hide after transition
                }, 5000);
            }

            callbackNumberTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'alternate') {
                        alternateNumberInputDiv.classList.remove('hidden');
                    } else {
                        alternateNumberInputDiv.classList.add('hidden');
                    }
                });
            });

            scheduleFormElement.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                if (CLOUD_FUNCTION_URL === 'https://us-central1-ujet-demo-credit-9gde.cloudfunctions.net/gcpteam-scheduled-callback-function') {
                    showMessage('Error: Cloud Function URL is not configured in the HTML.', 'error');
                    console.error('Cloud Function URL is not configured. Please edit the HTML file.');
                    return;
                }

                messageArea.classList.add('hidden', 'opacity-0'); // Clear previous messages quickly

                const dateValue = dateInput.value;
                const timeValue = timeInput.value;
                const selectedCallbackType = document.querySelector('input[name="callbackNumberType"]:checked').value;
                let callbackNumber;

                if (!dateValue || !timeValue) {
                    showMessage('Please select both date and time.', 'error');
                    return;
                }

                if (selectedCallbackType === 'alternate') {
                    const countryCode = countryCodeSelect.value;
                    const phoneNumber = alternatePhoneNumberInput.value.trim();
                    if (!phoneNumber) {
                        showMessage('Please enter an alternate phone number.', 'error');
                        alternatePhoneNumberInput.focus();
                        return;
                    }
                    if (!/^\d{7,15}$/.test(phoneNumber.replace(/\s+/g, ''))) {
                         showMessage('Please enter a valid phone number (7-15 digits).', 'error');
                         alternatePhoneNumberInput.focus();
                         return;
                    }
                    callbackNumber = countryCode + phoneNumber;
                } else {
                    callbackNumber = '+16477627687'; // Placeholder for "This Phone Number"
                                                    // In a real app, you'd get this dynamically or it would be pre-filled.
                                                    // For an embedded scenario, this might need to be an input field too.
                }

                const scheduledDateTime = `${dateValue}T${timeValue}:00.000Z`;

                scheduleButton.disabled = true;
                scheduleButton.textContent = 'Scheduling...';
                scheduleButton.classList.add('opacity-75', 'cursor-not-allowed');

                try {
                    const response = await fetch(CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scheduledDateTime, callbackNumber })
                    });

                    // Try to parse JSON, but handle cases where it might not be JSON (e.g. network error page)
                    let data;
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        data = await response.json();
                    } else {
                        // If not JSON, get text and construct an error-like object
                        const textResponse = await response.text();
                        data = { error: `Server returned non-JSON response: ${textResponse.substring(0,100)}...` };
                         // If response.ok is false but it wasn't JSON, we still want to show an error.
                        if (!response.ok) {
                           throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        }
                    }
                    
                    if (response.ok) {
                        showMessage('Callback scheduled successfully!', 'success');
                        scheduledDateTimeText.textContent = new Date(scheduledDateTime).toLocaleString();
                        scheduledPhoneNumberText.textContent = callbackNumber;
                        scheduleFormDiv.classList.add('hidden');
                        scheduledMessageDisplay.classList.remove('hidden');
                        console.log('Callback scheduled successfully:', data);
                    } else {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                    console.error('Fetch error:', error);
                } finally {
                    scheduleButton.disabled = false;
                    scheduleButton.textContent = 'Schedule Callback';
                    scheduleButton.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            });

            rescheduleButton.addEventListener('click', function() {
                scheduledMessageDisplay.classList.add('hidden');
                scheduleFormDiv.classList.remove('hidden');
                messageArea.classList.add('hidden', 'opacity-0');
                scheduleFormElement.reset(); // Reset the form fields
                // Ensure radio button state and alternate input visibility are reset
                document.getElementById('thisNumber').checked = true;
                alternateNumberInputDiv.classList.add('hidden');
            });

            const today = new Date();
            const minDate = today.toISOString().split('T')[0];
            dateInput.setAttribute('min', minDate);
            // Optional: Set a default date (e.g., today)
            // dateInput.value = minDate;

            // Optional: Set a default time (e.g., next whole hour)
            // const nextHour = new Date(today.getTime() + (60 - today.getMinutes()) * 60000);
            // timeInput.value = nextHour.toTimeString().substring(0,5);
        });
    </script>
</body>
</html>
